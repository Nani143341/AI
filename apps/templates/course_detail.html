{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <!-- User Profile and Course Information -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Your Profile</h5>
            <div class="row">
                <div class="col-md-6">
                    <p class="card-text"><strong>Username:</strong> {{ request.user.username }}</p>
                    <p class="card-text"><strong>Email:</strong> {{ request.user.email }}</p>
                    <p class="card-text"><strong>Premium Status:</strong> 
                        {% if request.user.userprofile.subscription_status %}
                            <span class="text-success">Yes</span>
                        {% else %}
                            <span class="text-danger">No</span>
                        {% endif %}
                    </p>
                    <p class="card-text"><strong>Enrollment Status:</strong> 
                        {% if is_enrolled %}
                            <span class="text-success">Enrolled in "{{ course.title }}"</span>
                        {% else %}
                            <span class="text-danger">Not Enrolled</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6 text-md-right">
                    <h1 class="display-4">{{ course.title }}</h1>
                    <p class="lead">{{ course.description }}</p>
                    <h4>Difficulty: {{ course.get_difficulty_display }}</h4>
                    {% if course.is_premium %}
                        <span class="badge badge-warning">Premium</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Video Section -->
    {% if first_video_id %}
    <div class="mb-4">
        <iframe class="w-100" height="450" src="https://www.youtube.com/embed/{{ first_video_id }}" frameborder="0" allowfullscreen></iframe>
    </div>
    {% else %}
    <p>No video found for this course.</p>
    {% endif %}

    {% if is_enrolled %}
    <!-- Course Progress Tracking -->
    <h4>Course Progress</h4>
    <div class="progress mt-4">
        <div class="progress-bar" role="progressbar" style="width: {{ progress.progress }}%;" aria-valuenow="{{ progress.progress }}" aria-valuemin="0" aria-valuemax="100">
            {{ progress.progress }}% Completed
        </div>
    </div>

    <!-- Update Progress -->
    <form method="POST" action="{% url 'blog:update_progress' course_id=course.id %}" class="mt-4">
        {% csrf_token %}
        <input type="hidden" name="update_progress" value="1">
        <button type="submit" class="btn btn-success">Mark Next Lesson as Completed</button>
    </form>

    <!-- Quiz Section -->
    {% if quizzes %}
    <h3 class="mt-4">Available Quizzes</h3>
    <div class="list-group">
        {% for quiz in quizzes %}
        <form method="POST" class="mt-2">
            {% csrf_token %}
            <input type="hidden" name="start_quiz" value="1">
            <input type="hidden" name="quiz_id" value="{{ quiz.id }}">
            <button type="submit" class="btn btn-primary mb-2">Start Quiz: {{ quiz.title }}</button>
        </form>
        {% endfor %}
    </div>
    {% else %}
    <p>No quizzes available for this course.</p>
    {% endif %}

    <!-- Quiz Results Section -->
    {% if quiz_results %}
    <h3 class="mt-4">Quiz Results</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Quiz Title</th>
                <th>Score</th>
                <th>Date Taken</th>
            </tr>
        </thead>
        <tbody>
            {% for result in quiz_results %}
            <tr>
                <td>{{ result.quiz.title }}</td>
                <td>{{ result.score }}</td>
                <td>{{ result.completed_at|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3" class="text-center">No quiz results available.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No quiz results available.</p>
    {% endif %}

    {% else %}
    <!-- Enrollment Form -->
    <h4>Enroll in Course</h4>
    <form method="POST" class="mt-4">
        {% csrf_token %}
        <input type="hidden" name="enroll" value="1">
        <button type="submit" class="btn btn-primary">Enroll in Course</button>
    </form>
    {% endif %}
</div>
{% endblock %}
